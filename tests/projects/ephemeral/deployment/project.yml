name: kong-dashboard
description: 'Graphical user interface to Kong API gateway'
maintainer: [ 'Marketplace', 'EV Home' ]
stages:
  build: Docker Build
  deploy: Kubernetes Deploy
deployment:
  namespace: kong
  kubernetes:
    portMappings:
      1337: 1337
    metrics:
      enabled: false
    labels:
      - key: traefik.enable
        all: 'true'
      - key: traefik.frontend.entryPoints
        all: 'http,https'
    resources:
      instances:
        all: 1
      request:
        mem:
          all: 128
        cpus:
          all: 0.1
      limit:
        mem:
          all: 1024
        cpus:
          all: 0.4
  properties:
    env:
      - key: NODE_ENV
        pr: "development"
        test: "development"
        acceptance: "production"
        production: "production"
      - key: RUN_MIGRATIONS
        all: "true"
      - key: DB_ADAPTER
        all: "postgres"
      - key: DB_HOST
        all: "acid-postgresql-kong.kong.svc.cluster.local"
      - key: DB_DATABASE
        all: "kong_dashboard"
      - key: KONGA_SEED_KONG_NODE_URL
        all: "http://kong-gateway.{namespace}.svc.cluster.local:8002"
      - key: KONGA_SEED_KONG_NODE_DATA_SOURCE_FILE
        all: "/seed_data/kong_nodes.data"
      - key: KONGA_SEED_USER_DATA_SOURCE_FILE
        all: "/seed_data/konga_users.data"
      - key: DB_SSL
        all: "true"
      - key: DB_USER
        all: "konga_read_write"
    vault:
      - key: TOKEN_SECRET
        path: "kong/dashboard/token_secret"
      - key: ADMIN_USERNAME
        path: "kong/dashboard/admin_username"
      - key: ADMIN_PASSWORD
        path: "kong/dashboard/admin_password"
      - key: ADMIN_API_KEY
        path: "kong/gateway/admin_api_key"
    kubernetes:
      - key: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "konga-read-write.acid-postgresql-kong.credentials.postgresql.acid.zalan.do"
            key: password
            optional: false
  traefik:
    enabled: true
    hosts:
      - host:
          pr: "Host(`kong-dashboard-{PR-NUMBER}.test.vdbinfra.nl`)"
          test: "Host(`kong-dashboard.test-backend.vdbinfra.nl`)"
          acceptance: "Host(`kong-dashboard.acce-backend.vdbinfra.nl`)"
          production: "Host(`kong-dashboard.prod-backend.vdbinfra.nl`)"
        servicePort: 1337
        tls:
          pr: "le-production-frontend-wildcard-cert"
          test: "le-prod-wildcard-cert"
          acceptance: "le-prod-wildcard-cert"
          production: "le-prod-wildcard-cert"
